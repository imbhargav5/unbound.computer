# iOS Sessions App - Architecture Diagram

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          iOS Sessions App                            â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     SessionListView                         â”‚   â”‚
â”‚  â”‚  â€¢ Displays all user sessions                               â”‚   â”‚
â”‚  â”‚  â€¢ Pull-to-refresh                                          â”‚   â”‚
â”‚  â”‚  â€¢ Navigation to detail                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                            â”‚
â”‚                         â†“ Tap Session                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   SessionDetailView                         â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚  Phase 1: Cold Load â„ï¸                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚  â”‚ 1. Fetch session metadata                    â”‚          â”‚   â”‚
â”‚  â”‚  â”‚ 2. Fetch last 100 events                     â”‚          â”‚   â”‚
â”‚  â”‚  â”‚ 3. Display immediately                       â”‚          â”‚   â”‚
â”‚  â”‚  â”‚ 4. Track seen event IDs                      â”‚          â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚  Phase 2: Hot Subscribe ğŸ”¥                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚  â”‚ 1. Connect WebSocket                         â”‚          â”‚   â”‚
â”‚  â”‚  â”‚ 2. Authenticate                              â”‚          â”‚   â”‚
â”‚  â”‚  â”‚ 3. Subscribe to session                      â”‚          â”‚   â”‚
â”‚  â”‚  â”‚ 4. Stream new events                         â”‚          â”‚   â”‚
â”‚  â”‚  â”‚ 5. Deduplicate & append                      â”‚          â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚         Event Timeline (Real-time)              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Output events (blue)                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Tool events (purple)                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Question events (orange)                         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ File events (indigo)                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Auto-scroll to latest                            â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚                 â”‚
                          â”‚                 â”‚
                    Cold Path â„ï¸         Hot Path ğŸ”¥
                          â”‚                 â”‚
                          â†“                 â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Supabase API     â”‚   â”‚ Relay WebSocket  â”‚
              â”‚  (PostgreSQL)     â”‚   â”‚                  â”‚
              â”‚                   â”‚   â”‚  wss://relay/    â”‚
              â”‚  Tables:          â”‚   â”‚                  â”‚
              â”‚  â€¢ sessions       â”‚   â”‚  Commands:       â”‚
              â”‚  â€¢ conv_events    â”‚   â”‚  â€¢ AUTHENTICATE  â”‚
              â”‚                   â”‚   â”‚  â€¢ SUBSCRIBE     â”‚
              â”‚  RLS Enabled âœ“    â”‚   â”‚  â€¢ UNSUBSCRIBE   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                  â”‚
                                      â”‚  Events:         â”‚
                                      â”‚  â€¢ CONVERSATION_ â”‚
                                      â”‚    EVENT         â”‚
                                      â”‚  â€¢ AUTH_SUCCESS  â”‚
                                      â”‚  â€¢ ERROR         â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â†“
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚  Redis Streams   â”‚
                                      â”‚                  â”‚
                                      â”‚  Key Format:     â”‚
                                      â”‚  session:X:cvs   â”‚
                                      â”‚                  â”‚
                                      â”‚  Max Length:     â”‚
                                      â”‚  10,000 msgs     â”‚
                                      â”‚                  â”‚
                                      â”‚  Poll Interval:  â”‚
                                      â”‚  1 second        â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â†‘
                                               â”‚
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚ macOS Executor   â”‚
                                      â”‚                  â”‚
                                      â”‚ HTTP POST        â”‚
                                      â”‚ /events          â”‚
                                      â”‚                  â”‚
                                      â”‚ Batch events â†’   â”‚
                                      â”‚ Redis stream     â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow Timeline

```
Time â†’
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’

T0: View Appears
    â”‚
    â””â”€â†’ [iOS] loadSessionCold()
         â”‚
         â”œâ”€â†’ [Supabase] SELECT * FROM sessions WHERE id = ?
         â”‚   â””â”€â†’ Response: session metadata
         â”‚
         â””â”€â†’ [Supabase] SELECT * FROM conversation_events
                         WHERE session_id = ? LIMIT 100
             â””â”€â†’ Response: [event1, event2, ..., event100]
                 â”‚
                 â””â”€â†’ [iOS] Display events immediately âœ“
                     â”‚
                     â””â”€â†’ Track seenEventIds = {e1, e2, ..., e100}

T1: Cold Load Complete (500ms)
    â”‚
    â””â”€â†’ [iOS] subscribeHot()
         â”‚
         â”œâ”€â†’ [WebSocket] connect() to wss://relay
         â”‚   â””â”€â†’ Connection established
         â”‚
         â”œâ”€â†’ [WebSocket] send(AUTHENTICATE)
         â”‚   â””â”€â†’ Response: AUTH_SUCCESS
         â”‚
         â””â”€â†’ [WebSocket] send(SUBSCRIBE { sessionId })
             â””â”€â†’ Response: SUBSCRIBED

T2: Hot Connected (800ms)
    â”‚
    â””â”€â†’ [iOS] Connection indicator: "Live" ğŸŸ¢
        â”‚
        â””â”€â†’ Start listening to event stream

T3: New Event Created on Executor
    â”‚
    â””â”€â†’ [macOS] POST /events { sessionId, events: [...] }
         â”‚
         â””â”€â†’ [Relay] XADD session:X:cvs { eventId, type, payload }
              â”‚
              â””â”€â†’ [Redis] Stream length: 101
                   â”‚
                   â””â”€â†’ [Relay] Poll stream (1s interval)
                        â”‚
                        â””â”€â†’ [Relay] XREAD session:X:cvs
                             â””â”€â†’ New message: event101

T4: Event Broadcast (50ms latency)
    â”‚
    â””â”€â†’ [Relay] WebSocket.send(CONVERSATION_EVENT { event101 })
         â”‚
         â””â”€â†’ [iOS] Receive event via AsyncStream
              â”‚
              â”œâ”€â†’ Check: seenEventIds.contains(event101.id) â†’ false âœ“
              â”‚
              â”œâ”€â†’ Append to events array
              â”‚
              â”œâ”€â†’ Add to seenEventIds
              â”‚
              â””â”€â†’ SwiftUI auto-updates view
                   â”‚
                   â””â”€â†’ Auto-scroll to bottom âœ“

T5: User Scrolls Up to Load More
    â”‚
    â””â”€â†’ [iOS] loadMoreEvents()
         â”‚
         â””â”€â†’ [Supabase] SELECT * FROM conversation_events
                         WHERE session_id = ?
                         AND created_at < first_event.created_at
                         LIMIT 50
             â””â”€â†’ Response: [event-50, ..., event-1]
                 â”‚
                 â””â”€â†’ Prepend to events array
                     â”‚
                     â””â”€â†’ No duplicates (already tracked)

T6: Connection Lost
    â”‚
    â””â”€â†’ [iOS] WebSocket error
         â”‚
         â”œâ”€â†’ Connection indicator: "Disconnected" ğŸ”´
         â”‚
         â””â”€â†’ attemptReconnect()
              â”‚
              â”œâ”€â†’ Attempt 1: delay 2s
              â”œâ”€â†’ Attempt 2: delay 4s
              â”œâ”€â†’ Attempt 3: delay 8s
              â””â”€â†’ Connection restored â†’ "Live" ğŸŸ¢
                   â”‚
                   â””â”€â†’ Resume streaming from last event
```

## Component Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         App Layer                              â”‚
â”‚                                                                â”‚
â”‚  SessionsApp.swift                                             â”‚
â”‚  â””â”€â†’ SessionListView                                           â”‚
â”‚       â””â”€â†’ SessionDetailView                                    â”‚
â”‚            â””â”€â†’ EventRowView                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ViewModel Layer                           â”‚
â”‚                      (@MainActor)                              â”‚
â”‚                                                                â”‚
â”‚  SessionListViewModel                                          â”‚
â”‚  â€¢ @Published sessions: [CodingSession]                        â”‚
â”‚  â€¢ @Published isLoading: Bool                                  â”‚
â”‚  â€¢ loadSessions() async                                        â”‚
â”‚                                                                â”‚
â”‚  SessionDetailViewModel                                        â”‚
â”‚  â€¢ @Published session: CodingSession?                          â”‚
â”‚  â€¢ @Published events: [ConversationEvent]                      â”‚
â”‚  â€¢ @Published connectionState: ConnectionState                 â”‚
â”‚  â€¢ loadSessionCold() async                                     â”‚
â”‚  â€¢ subscribeHot() async                                        â”‚
â”‚  â€¢ private seenEventIds: Set<String>                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Service Layer                             â”‚
â”‚                      (actors + @MainActor)                     â”‚
â”‚                                                                â”‚
â”‚  @MainActor SupabaseService                                    â”‚
â”‚  â€¢ fetchSessions() async throws                                â”‚
â”‚  â€¢ fetchSession(UUID) async throws                             â”‚
â”‚  â€¢ fetchEvents(...) async throws                               â”‚
â”‚  â€¢ Uses: supabase-swift SDK                                    â”‚
â”‚                                                                â”‚
â”‚  actor RelayWebSocketService                                   â”‚
â”‚  â€¢ connect() async throws                                      â”‚
â”‚  â€¢ authenticate(...) async throws                              â”‚
â”‚  â€¢ subscribe(sessionId) async throws                           â”‚
â”‚  â€¢ eventStream: AsyncStream<RelayEvent>                        â”‚
â”‚  â€¢ Reconnection logic with backoff                             â”‚
â”‚                                                                â”‚
â”‚  @MainActor AuthenticationService                              â”‚
â”‚  â€¢ initWebSession() async throws                               â”‚
â”‚  â€¢ waitForAuthorization(...) async throws                      â”‚
â”‚  â€¢ Uses: KeychainHelper for storage                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Model Layer                              â”‚
â”‚                       (Codable + Sendable)                     â”‚
â”‚                                                                â”‚
â”‚  struct CodingSession                                          â”‚
â”‚  â€¢ id, userId, title, status                                   â”‚
â”‚  â€¢ metadata, statistics                                        â”‚
â”‚                                                                â”‚
â”‚  struct ConversationEvent                                      â”‚
â”‚  â€¢ eventId, sessionId, type                                    â”‚
â”‚  â€¢ payload: EventPayload                                       â”‚
â”‚  â€¢ 47+ event types                                             â”‚
â”‚                                                                â”‚
â”‚  enum RelayCommand / RelayEvent                                â”‚
â”‚  â€¢ WebSocket protocol messages                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Deduplication Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Deduplication Flow                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Initialize
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ seenEventIds    â”‚
â”‚ = Set<String>() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: Cold Load
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Events from Supabase:               â”‚
â”‚ [e1, e2, e3, ..., e100]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ seenEventIds.insert(e1)             â”‚
â”‚ seenEventIds.insert(e2)             â”‚
â”‚ ...                                 â”‚
â”‚ seenEventIds.insert(e100)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ seenEventIds = {e1, e2, ..., e100}  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: Hot Stream Starts
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Relay broadcasts all events         â”‚
â”‚ including cold-loaded ones          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 4: Receive Event from Hot Path
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event e95 arrives via WebSocket     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ if seenEventIds.contains(e95) {     â”‚
â”‚   return // Skip duplicate âœ“        â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 5: New Event
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event e101 arrives via WebSocket    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ if seenEventIds.contains(e101) {    â”‚
â”‚   // false, not seen before         â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ events.append(e101)                 â”‚
â”‚ seenEventIds.insert(e101)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Result: No duplicates in UI! âœ“
```

## Reconnection Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Reconnection Flow                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

State: Connected ğŸŸ¢
   â”‚
   â””â”€â†’ WebSocket error occurs
        â”‚
        â†“
   State: Reconnecting (1) ğŸŸ 
        â”‚
        â””â”€â†’ delay = min(2^1, 30) = 2s
             â”‚
             â””â”€â†’ Task.sleep(2s)
                  â”‚
                  â””â”€â†’ try connect()
                       â”‚
                       â”œâ”€â†’ Success â†’ Connected ğŸŸ¢
                       â”‚              reconnectAttempts = 0
                       â”‚
                       â””â”€â†’ Failure â†’ Reconnecting (2) ğŸŸ 
                                     â”‚
                                     â””â”€â†’ delay = min(2^2, 30) = 4s
                                          â”‚
                                          â””â”€â†’ Task.sleep(4s)
                                               â”‚
                                               â””â”€â†’ try connect()
                                                    â”‚
                                                    â”œâ”€â†’ Success â†’ Connected ğŸŸ¢
                                                    â”‚
                                                    â””â”€â†’ Failure â†’ Reconnecting (3) ğŸŸ 
                                                                 â”‚
                                                                 â””â”€â†’ delay = 8s
                                                                      â””â”€â†’ ... continues

Max attempts: 10
Max delay: 30s

After 10 failures:
State: Failed ğŸ”´
â””â”€â†’ Show error to user
     â””â”€â†’ Allow manual retry
```

## Event Categories & Styling

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Event Rendering                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Output Events (Blue)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¬ Output Chunk                     â”‚
â”‚ "Hello from Claude!"                â”‚
â”‚ 10:30:45 AM                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Tool Events (Purple)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”¨ Tool Started                     â”‚
â”‚ Tool: bash                          â”‚
â”‚ 10:30:46 AM                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Question Events (Orange)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â“ Question Asked                   â”‚
â”‚ "Would you like to proceed?"        â”‚
â”‚ 10:30:47 AM                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

File Events (Indigo)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„ File Created                     â”‚
â”‚ Path: /Users/test/file.swift        â”‚
â”‚ 10:30:48 AM                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Error Events (Red)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ Session Error                     â”‚
â”‚ "Rate limit exceeded"               â”‚
â”‚ 10:30:49 AM                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Security Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Security Layers                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 1: Transport Security
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ HTTPS only for API calls          â”‚
â”‚ â€¢ WSS (WebSocket Secure) for relay  â”‚
â”‚ â€¢ Certificate validation âœ“          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 2: Authentication
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ QR code device authorization      â”‚
â”‚ â€¢ Session token (24h expiration)    â”‚
â”‚ â€¢ Device ID verification            â”‚
â”‚ â€¢ Stored in Keychain âœ“              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 3: Authorization (RLS)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Row-Level Security in Supabase    â”‚
â”‚ â€¢ User can only see own sessions    â”‚
â”‚ â€¢ User can only see own events      â”‚
â”‚ â€¢ Enforced at database level âœ“      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 4: Data Validation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Type-safe models (Codable)        â”‚
â”‚ â€¢ Sendable conformance              â”‚
â”‚ â€¢ No force unwraps                  â”‚
â”‚ â€¢ Proper error handling âœ“           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Performance Optimizations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Performance Features                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Lazy Loading
   â€¢ LazyVStack for event list
   â€¢ Only renders visible events
   â€¢ Memory efficient for 1000+ events

2. Pagination
   â€¢ Load 100 events initially
   â€¢ Load 50 more on scroll up
   â€¢ Prevents loading entire history

3. AsyncStream
   â€¢ Non-blocking event streaming
   â€¢ Backpressure handling
   â€¢ Memory-efficient buffering

4. Set-based Deduplication
   â€¢ O(1) lookup time
   â€¢ Memory: ~32 bytes per event ID
   â€¢ Fast even with 10,000 events

5. Actor Isolation
   â€¢ Thread-safe WebSocket service
   â€¢ Prevents data races
   â€¢ Efficient concurrency

6. Connection Pooling
   â€¢ Single WebSocket per session
   â€¢ Reuses connection for multiple ops
   â€¢ Low battery impact
```

---

**Legend:**
- â„ï¸ = Cold path (database query)
- ğŸ”¥ = Hot path (real-time streaming)
- ğŸŸ¢ = Connected/Healthy
- ğŸŸ  = Connecting/Warning
- ğŸ”´ = Disconnected/Error
- âœ“ = Completed/Verified
